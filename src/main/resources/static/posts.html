<!DOCTYPE html>
<html ng-app="PostApp">
<head>
<title>Post App</title>
<meta charset="utf-8">

<script
        src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
<script
        src="http://angular-ui.github.com/bootstrap/ui-bootstrap-tpls-0.1.0.js"></script>
<link
        href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.0/css/bootstrap-combined.min.css"
        rel="stylesheet">
<link rel="stylesheet" type="text/css" href="table.css" />
<link rel="stylesheet" type="text/css" href="posts.css" />


<script>
var app = angular.module('PostApp', ['ui.bootstrap']);

        function loadPosts ($scope, $http){
                $http({
                 method : 'GET',
                 //url : 'http://test-api-308.herokuapp.com/post'
		 //url : 'http://cp-missingsemicolons.herokuapp.com/post'
		 url: 'http://localhost:8080/post'
                }).then(function (response) {
                         $scope.posts = response.data;
                });
        }

app.controller('PostCtrl', function ($scope, $http, $dialog) {
        
        loadPosts($scope, $http);
  
  
        $scope.save = function(post) {
		var postRequest = {
			method: 'POST',
			url: 'http://localhost:8080/post',
			data: {
				messageBody: $scope.post.messageBody,
				name: $scope.post.name,
				title: $scope.post.title,
				location: $scope.post.location,
				tags: $scope.post.tags
			}
		}
		$http(postRequest).then(function(response) {
			$scope.post = response.data;
		});
        
        };
  
        var addDialogOptions = {
        	controller: 'AddPostCtrl',
        	templateUrl: './postAdd.html'
        };
        
        $scope.add = function(post){
        	$dialog.dialog(angular.extend(addDialogOptions, {})).open()
        	.then(function () {
                	loadPosts($scope, $http);
                });
        };
        
        var editDialogOptions = {
            controller: 'EditPostCtrl',
            templateUrl: './postEdit.html',
        };

        $scope.edit = function(post) {
                var postToEdit = post;
        	$dialog.dialog(angular.extend(editDialogOptions, {resolve: {post: angular.copy(postToEdit)}})).open().then(function () {
		loadPosts($scope, $http);
        	});
	};

	var deleteDialogOptions = {
		controller: 'DeletePostCtrl',
		templateUrl: './postDelete.html',
	};

	$scope.delete = function(post) {
                var deleteRequest = {
                        method: 'DELETE',
                        url: 'http://cp-missingsemicolons.herokuapp.com/post/' + post.id,
                }
                $http(deleteRequest).then(function(response) {
			loadPosts($scope, $http);
                });
        
	}
        
});
app.controller('EditPostCtrl', function ($scope, $http, post, dialog) {
  
        $scope.post = post;

        $scope.save = function($post) {
            var putRequest = {
        		method : 'PUT',
        		url : 'http://cp-missingsemicolons.herokuapp.com/post/'+ $scope.post.id ,
        		data: {
                                messageBody: $scope.post.messageBody
                        }
           }  
                
                $http(putRequest).then(function (response) {
                    $scope.post = response.data;
                });
                //todo handle error
        $scope.close();
        };
  
        $scope.close = function(){
                loadPosts($scope, $http);
        dialog.close();
        };
});


app.controller('AddPostCtrl', function($scope, $http, dialog){
  
        $scope.save = function(post) {
		console.log("in save function:)");
		var postRequest = {
			method: 'POST',
			url: 'http://cp-missingsemicolons.herokuapp.com/post',
			data: {
				messageBody: $scope.post.messageBody
			}
		}
		$http(postRequest).then(function(response) {
			$scope.post = response.data;
		});
        
        	$scope.close();
        };
  
        $scope.close = function(){
		loadPosts($scope, $http);
        	dialog.close(undefined);
        };
});

app.controller('DeletePostCtrl', function($scope, post) {
});


</script>
</head>
<body>
        <div ng-controller="PostCtrl">
                <h1>International Activity Meter</h1>
                                <td colspan=1>&nbsp;</td> <br />
				<input ng-model="post.name" placeholder="Name" class="txt-input" size="40"/>
				<br \>
				<input ng-model="post.title" placeholder="Title (Student/Professor)" class="txt-input" size="40"/>
				<br \>
				<input ng-model="post.location" placeholder="Location" class="txt-input" size="40"/>
				<br \>
				<input ng-model="post.messageBody" placeholder="Write about your experiences!" class="txt-input" size="40"/>
				<br />
				<input ng-model="post.tags" placeholder="#tags" class="txt-input" size="40"/>
                                <button ng-click="save(post)">Create post</button>
		<table>
			
                        <tr ng-repeat="p in posts">
				<td>
					<b><font size="5">{{p.name}}</font></b><br />
					{{p.title}}<br />
					{{p.location}}<br />
                                	<font size="5">
						{{p.messageBody}}
						{{p.tags == null ? "" : "#" + p.tags}}
					</font>
				</td>
                                <td><button ng-click="edit(p)">edit</button>
                                        <button ng-click="delete(p)">delete</button></td>
                        </tr>
                </table>
        </div>
</body>
</html>
